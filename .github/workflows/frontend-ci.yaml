# Workflow: Frontend Continuous Integration
# Purpose: Lint, test, and build the frontend on PRs to main (frontend path). Manual runs allowed.
# TODO: If Node version changes, update "node-version" below.

name: Frontend Continuous Integration

on:
  # Trigger on pull requests to main when frontend files change
  pull_request:
    branches: [ main ]
    paths:
      - starter/frontend/**
  # Allow manual runs
  workflow_dispatch: {}

jobs:
  # Lint and test run in parallel by default (no "needs" between them)
  lint:
    name: Lint (frontend)
    runs-on: ubuntu-latest
    steps:
      # Checkout repo
      - name: Checkout code
        uses: actions/checkout@v3

      # Setup Node.js runtime
      - name: Setup Node.js 18.x
        uses: actions/setup-node@v3
        with:
          node-version: 18.x

      # Restore npm cache (speeds up installs)
      - name: Restore npm cache
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-frontend-${{ hashFiles('starter/frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-frontend-

      # Install dependencies (clean, reproducible)
      - name: Install dependencies
        working-directory: starter/frontend
        run: npm ci

      # Run linter - fails job on errors
      - name: Run linter
        working-directory: starter/frontend
        run: npm run lint

  test:
    name: Test (frontend)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js 18.x
        uses: actions/setup-node@v3
        with:
          node-version: 18.x

      - name: Restore npm cache
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-frontend-${{ hashFiles('starter/frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-frontend-

      - name: Install dependencies
        working-directory: starter/frontend
        run: npm ci

      # CI=true => non-interactive tests with proper exit code on failure
      - name: Run tests (CI mode)
        env:
          CI: true
        working-directory: starter/frontend
        run: npm test

  build:
    # Build only runs after both lint and test succeed
    name: Build Docker image (frontend)
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js 18.x
        uses: actions/setup-node@v3
        with:
          node-version: 18.x

      - name: Restore npm cache
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-frontend-${{ hashFiles('starter/frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-frontend-

      - name: Install dependencies
        working-directory: starter/frontend
        run: npm ci

      # Build Docker image from the frontend Dockerfile (no push in CI)
      # TODO: Adjust image name if you prefer a different local tag
      - name: Build Docker image
        run: |
          docker build -f starter/frontend/Dockerfile -t mp-frontend:${{ github.sha }} starter/frontend
